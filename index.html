<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VoiceSafe ‚Äî Scam Voice Check</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Aby to p√¥sobilo premium */
    body { background: radial-gradient(1200px 800px at 20% 10%, rgba(255,215,0,.08), transparent 60%),
                     radial-gradient(900px 700px at 80% 30%, rgba(99,102,241,.10), transparent 55%),
                     #06070b; }
    .glass { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.10); }
    .gold { background: linear-gradient(90deg, rgba(255,215,0,.25), rgba(255,255,255,.06)); border: 1px solid rgba(255,215,0,.25); }
    .btn { transition: transform .08s ease; }
    .btn:active { transform: translateY(1px); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body class="text-white">
  <div class="max-w-5xl mx-auto px-4 py-10">

    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full gold text-sm">
          <span>üõ°Ô∏è</span>
          <span class="font-semibold">VoiceSafe ‚Ä¢ Public Beta</span>
        </div>
        <h1 class="text-3xl md:text-5xl font-bold mt-4 leading-tight">
          Upload a suspicious voice message.<br class="hidden md:block" />
          <span class="text-yellow-200">Get a clear risk verdict in seconds.</span>
        </h1>
        <p class="text-white/70 mt-3 max-w-2xl">
          VoiceSafe analyzes voice messages for scam-like patterns. Results are guidance, not proof. Always verify before sending money.
        </p>
      </div>

      <div class="glass rounded-2xl p-4 md:p-5 w-full md:w-[360px]">
        <div class="text-sm text-white/60">Status</div>
        <div id="statusLine" class="mt-1 font-semibold">Ready</div>
        <div class="mt-3 text-xs text-white/50">
          Backend: <span class="mono" id="backendUrlLabel"></span><br/>
          Tip: You can share reports via link.
        </div>
      </div>
    </div>

    <!-- Main -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
      <!-- Left: Upload / Record -->
      <div class="glass rounded-2xl p-5">
        <h2 class="text-xl font-bold">1) Upload or record</h2>
        <p class="text-white/60 text-sm mt-1">Supported: mp3, wav, m4a, mp4, webm (best results with clear speech).</p>

        <div class="mt-5">
          <label class="block text-sm text-white/70 mb-2">Upload audio/video file</label>
          <input id="fileInput" type="file" class="block w-full text-sm
            file:mr-4 file:rounded-xl file:border-0 file:px-4 file:py-2
            file:bg-yellow-200 file:text-black file:font-semibold
            bg-white/5 rounded-xl border border-white/10 p-2" />
          <div id="fileName" class="text-xs text-white/60 mt-2"></div>
        </div>

        <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-3">
          <button id="btnAnalyze" class="btn rounded-xl px-4 py-3 font-semibold bg-yellow-200 text-black disabled:opacity-40 disabled:cursor-not-allowed">
            Analyze
          </button>
          <button id="btnClear" class="btn rounded-xl px-4 py-3 font-semibold bg-white/10 border border-white/10">
            Clear
          </button>
        </div>

        <div class="mt-6 p-4 rounded-xl bg-white/5 border border-white/10">
          <div class="text-sm font-semibold">Privacy</div>
          <ul class="text-xs text-white/60 mt-2 space-y-1 list-disc pl-5">
            <li>Do not upload sensitive personal data.</li>
            <li>Results are for safety guidance, not legal proof.</li>
            <li>For emergencies or financial fraud, contact local authorities/bank.</li>
          </ul>
        </div>
      </div>

      <!-- Right: Result -->
      <div class="glass rounded-2xl p-5">
        <h2 class="text-xl font-bold">2) Result</h2>
        <p class="text-white/60 text-sm mt-1">A clear verdict + recommended actions.</p>

        <div id="resultBox" class="mt-5 p-5 rounded-2xl border border-white/10 bg-white/5">
          <div class="text-white/60 text-sm">No analysis yet.</div>
          <div class="text-xs text-white/40 mt-1">Upload a file and press Analyze.</div>
        </div>

        <!-- Share / Report -->
        <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-3">
          <button id="btnSaveCase" class="btn rounded-xl px-4 py-3 font-semibold bg-white/10 border border-white/10 disabled:opacity-40 disabled:cursor-not-allowed" disabled>
            Save Report
          </button>
          <button id="btnCopyLink" class="btn rounded-xl px-4 py-3 font-semibold bg-white/10 border border-white/10 disabled:opacity-40 disabled:cursor-not-allowed" disabled>
            Copy Share Link
          </button>
        </div>

        <div class="mt-3 text-xs text-white/50">
          Report ID: <span id="reportId" class="mono text-white/70">‚Äî</span>
        </div>

        <div id="toast" class="hidden mt-4 text-sm px-4 py-3 rounded-xl bg-black/50 border border-white/10"></div>
      </div>
    </div>

    <!-- Footer -->
    <div class="mt-10 text-xs text-white/40">
      ¬© <span id="year"></span> VoiceSafe. Use responsibly.
    </div>
  </div>

<script>
  // ===== CONFIG (lok√°lne)
  const BACKEND = "http://127.0.0.1:10000";
  document.getElementById("backendUrlLabel").textContent = BACKEND;

  // ===== UI refs
  const statusLine = document.getElementById("statusLine");
  const fileInput = document.getElementById("fileInput");
  const fileName = document.getElementById("fileName");
  const btnAnalyze = document.getElementById("btnAnalyze");
  const btnClear = document.getElementById("btnClear");
  const resultBox = document.getElementById("resultBox");
  const btnSaveCase = document.getElementById("btnSaveCase");
  const btnCopyLink = document.getElementById("btnCopyLink");
  const reportIdEl = document.getElementById("reportId");
  const toast = document.getElementById("toast");

  let lastAnalysis = null;
  let lastCaseId = null;

  // ===== helpers
  function showToast(msg) {
    toast.textContent = msg;
    toast.classList.remove("hidden");
    setTimeout(() => toast.classList.add("hidden"), 2200);
  }

  function setStatus(msg) { statusLine.textContent = msg; }

  function verdictStyles(level) {
    if (level === "high") return {
      badge: "bg-red-500/20 border-red-400/30 text-red-200",
      title: "text-red-200",
      bar: "bg-red-400"
    };
    if (level === "suspicious") return {
      badge: "bg-yellow-500/20 border-yellow-400/30 text-yellow-200",
      title: "text-yellow-200",
      bar: "bg-yellow-300"
    };
    return {
      badge: "bg-emerald-500/20 border-emerald-400/30 text-emerald-200",
      title: "text-emerald-200",
      bar: "bg-emerald-300"
    };
  }

  function pct(n) {
    const x = Number(n);
    if (Number.isNaN(x)) return "0%";
    return `${Math.round(x)}%`;
  }

  function renderResult(payload) {
    lastAnalysis = payload;
    const v = payload.verdict || {};
    const level = v.level || "safe";
    const st = verdictStyles(level);

    const bullets = Array.isArray(v.bullets) ? v.bullets : [];
    const actions = Array.isArray(v.actions) ? v.actions : [];

    resultBox.innerHTML = `
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border ${st.badge} text-xs font-semibold">
            ${level === "high" ? "üî¥" : level === "suspicious" ? "üü†" : "üü¢"}
            <span>${v.title || "RESULT"}</span>
          </div>
          <div class="mt-3 text-lg font-bold ${st.title}">
            ${v.short || "Analysis completed."}
          </div>
          <div class="text-xs text-white/50 mt-1 mono">
            File: ${payload.filename || "‚Äî"}
          </div>
        </div>

        <div class="min-w-[150px]">
          <div class="text-xs text-white/60">Scam Risk</div>
          <div class="text-2xl font-bold">${pct(payload.scam_score)}</div>
          <div class="h-2 rounded-full bg-white/10 overflow-hidden mt-2">
            <div class="h-2 ${st.bar}" style="width:${Math.max(0, Math.min(100, Number(payload.scam_score)||0))}%"></div>
          </div>
          <div class="text-[11px] text-white/45 mt-2">
            AI voice: ${pct(payload.ai_voice_prob)} ‚Ä¢ Pressure: ${pct(payload.stress_level)}
          </div>
        </div>
      </div>

      <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="p-4 rounded-xl bg-black/20 border border-white/10">
          <div class="text-sm font-semibold">Why this verdict?</div>
          <ul class="text-xs text-white/60 mt-2 space-y-1 list-disc pl-5">
            ${bullets.map(b => `<li>${escapeHtml(b)}</li>`).join("") || "<li>No details.</li>"}
          </ul>
        </div>

        <div class="p-4 rounded-xl bg-black/20 border border-white/10">
          <div class="text-sm font-semibold">Recommended actions</div>
          <ol class="text-xs text-white/60 mt-2 space-y-1 list-decimal pl-5">
            ${actions.map(a => `<li>${escapeHtml(a)}</li>`).join("") || "<li>Verify independently before sending money.</li>"}
          </ol>
        </div>
      </div>
    `;

    btnSaveCase.disabled = false;
    btnCopyLink.disabled = true; // link a≈æ po ulo≈æen√≠ case
    reportIdEl.textContent = "‚Äî";
    lastCaseId = null;
  }

  function escapeHtml(str) {
    return (str || "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  // ===== actions
  fileInput.addEventListener("change", () => {
    const f = fileInput.files?.[0];
    fileName.textContent = f ? `Selected: ${f.name} (${Math.round(f.size/1024)} KB)` : "";
    btnAnalyze.disabled = !f;
  });

  btnClear.addEventListener("click", () => {
    fileInput.value = "";
    fileName.textContent = "";
    btnAnalyze.disabled = true;

    lastAnalysis = null;
    lastCaseId = null;

    resultBox.innerHTML = `
      <div class="text-white/60 text-sm">Cleared.</div>
      <div class="text-xs text-white/40 mt-1">Upload a file and press Analyze.</div>
    `;

    btnSaveCase.disabled = true;
    btnCopyLink.disabled = true;
    reportIdEl.textContent = "‚Äî";
    setStatus("Ready");
  });

  btnAnalyze.addEventListener("click", async () => {
    const f = fileInput.files?.[0];
    if (!f) return;

    setStatus("Analyzing‚Ä¶");
    btnAnalyze.disabled = true;
    btnSaveCase.disabled = true;
    btnCopyLink.disabled = true;

    try {
      const fd = new FormData();
      fd.append("file", f);

      const res = await fetch(`${BACKEND}/upload`, { method: "POST", body: fd });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const data = await res.json();
      renderResult(data);
      setStatus("Analysis complete ‚úÖ");
      showToast("Analysis complete");
    } catch (e) {
      console.error(e);
      setStatus("Error");
      showToast("Analyze failed. Check backend/AI servers.");
    } finally {
      btnAnalyze.disabled = !fileInput.files?.[0];
    }
  });

  // Save report (case)
  btnSaveCase.addEventListener("click", async () => {
    if (!lastAnalysis) return;
    if (!confirm("Save this analysis as a report (case)?")) return;

    setStatus("Saving report‚Ä¶");

    try {
      const payload = {
        meta: {
          title: "VoiceSafe Report",
          platform: "",
          country: "",
          language: "EN",
          tags: ["scam-check"],
          notes: "",
        },
        data: lastAnalysis,
      };

      const res = await fetch(`${BACKEND}/case`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const out = await res.json();

      lastCaseId = out.caseId;
      reportIdEl.textContent = lastCaseId || "‚Äî";

      btnCopyLink.disabled = !lastCaseId;
      setStatus("Report saved ‚úÖ");
      showToast("Report saved");
    } catch (e) {
      console.error(e);
      setStatus("Save failed");
      showToast("Save failed. Is DB enabled?");
    }
  });

  // Copy share link
  btnCopyLink.addEventListener("click", async () => {
    if (!lastCaseId) return;
    const url = `${location.origin}${location.pathname}?case=${encodeURIComponent(lastCaseId)}`;
    try {
      await navigator.clipboard.writeText(url);
      showToast("Share link copied ‚úÖ");
    } catch {
      showToast(url); // fallback
    }
  });

  // Load case from URL (?case=ID)
  async function loadCaseFromUrl() {
    const params = new URLSearchParams(location.search);
    const id = params.get("case");
    if (!id) return;

    setStatus("Loading report‚Ä¶");
    try {
      const res = await fetch(`${BACKEND}/case/${encodeURIComponent(id)}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const out = await res.json();

      const payload = out?.case?.data;
      if (!payload) throw new Error("No data in case");

      renderResult(payload);

      lastCaseId = id;
      reportIdEl.textContent = id;
      btnCopyLink.disabled = false;

      setStatus("Report loaded ‚úÖ");
      showToast("Report loaded");
    } catch (e) {
      console.error(e);
      setStatus("Could not load report");
      showToast("Could not load report (case not found).");
    }
  }

  document.getElementById("year").textContent = new Date().getFullYear();
  btnAnalyze.disabled = true;

  // auto-load case if present
  loadCaseFromUrl();
</script>
</body>
</html>